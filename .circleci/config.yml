version: 2.1
orbs:
  kube-orb: circleci/kubernetes@0.3.0
jobs:
  build:
    environment: CHANGE_MINIKUBE_NONE_USER=true
    machine:
      image: 'circleci/classic:201808-01'
    steps:
      - checkout
      - kube-orb/install
      - run:
          command: >
            curl -Lo minikube
            https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
            \
              && chmod +x minikube
            sudo cp minikube /usr/local/bin && rm minikube

            sudo -E minikube start --vm-driver=none --cpus 2 --memory 2048
          name: Start minikube
      - kube-orb/create-or-update-resource:
          get-rollout-status: true
          resource-file-path: conformance/StageConformanceTestsData.yaml
          resource-name: job/stage-conformance-test-data
          show-kubectl-command: true
      - kube-orb/create-or-update-resource:
          get-rollout-status: true
          resource-file-path: conformance/ConformanceTestsJob.yaml
          resource-name: job/conformance-tests
          show-kubectl-command: true
      - run:
         command: >
           sleep 5 && kubectl logs jobs/conformance-tests
      - kube-orb/delete-resource:
          now: true
          resource-names: job/conformance-tests,job/stage-conformance-test-data
          resource-types: jobs
          wait: true
