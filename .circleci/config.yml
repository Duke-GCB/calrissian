version: 2.1
orbs:
  kube-orb: circleci/kubernetes@0.3.0
jobs:
  build:
    environment: CHANGE_MINIKUBE_NONE_USER=true
    machine:
      image: 'circleci/classic:201808-01'
    steps:
      - checkout
      - kube-orb/install
      # build the conformance-testing image
      - run: docker build -t calrissian:conformance -f conformance/Dockerfile.conformance .
      - run:
          command: >
            curl -Lo minikube
            https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
            \
              && chmod +x minikube
            sudo cp minikube /usr/local/bin && rm minikube

            sudo -E minikube start --vm-driver=none --cpus 2 --memory 2048
          name: Start minikube
      - run:
          command: >
            kubectl create -f conformance/StageConformanceTestsData.yaml;
            kubectl wait --for=condition=complete --timeout 180s job/stage-conformance-test-data;
            kubectl logs job/stage-conformance-test-data
      - run:
          command: >
            kubectl create -f conformance/ConformanceTestsJob.yaml;
            kubectl wait --for=condition=running --selector=job-name=conformance-tests pods;
            kubectl logs -f job/conformance-tests
