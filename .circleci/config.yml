version: 2.1
orbs:
  kube-orb: circleci/kubernetes@0.3.0
jobs:
  build:
    environment: CHANGE_MINIKUBE_NONE_USER=true
    machine:
      image: 'circleci/classic:201808-01'
    steps:
      - checkout
      - kube-orb/install
      # build the conformance-testing image
      - run: docker build -t calrissian:conformance -f conformance/Dockerfile.conformance .
      - run:
          command: >
            curl -Lo minikube
            https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
            \
              && chmod +x minikube
            sudo cp minikube /usr/local/bin && rm minikube

            sudo -E minikube start --vm-driver=none --cpus 4 --memory 8192
          name: Start minikube
      - run:
          command: >
            kubectl create -f conformance/StageConformanceTestsData.yaml

            kubectl wait --for=condition=complete --timeout 180s job/stage-conformance-test-data

            kubectl logs job/stage-conformance-test-data
      # Create roles/bindings to grant API access
      - run:
          command: kubectl create -f conformance/Roles.yaml
      - run:
          command: ./conformance/run-conformance.sh
      # Copy junit file out of pod
      - run:
          command: >
            kubectl cp conformance-tests:/output/calrissian-conformance.xml calrissian-conformance.xml

      # Store artifacts
      - store_artifacts:
          path: calrissian-conformance.xml
          destination: calrissian-conformance
      # Cleanup
      - run:
          command: >
            kubectl delete pod conformance-tests

            kubectl delete -f conformance/StageConformanceTestsData.yaml

            kubectl delete -f conformance/Roles.yaml
      # Stop Minikube
      - run:
          command: >
            sudo -E minikube stop

            sudo -E minikube delete
