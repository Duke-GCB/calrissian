version: 2.1
orbs:
  kube-orb: circleci/kubernetes@0.3.0
jobs:
  build:
    environment: CHANGE_MINIKUBE_NONE_USER=true
    machine:
      image: 'circleci/classic:201808-01'
    steps:
      - checkout
      - kube-orb/install
      # build the conformance-testing image
      - run: docker build -t calrissian:conformance -f conformance/Dockerfile.conformance .
      - run:
          command: >
            curl -Lo minikube
            https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
            \
              && chmod +x minikube
            sudo cp minikube /usr/local/bin && rm minikube

            sudo -E minikube start --vm-driver=none --cpus 2 --memory 2048
          name: Start minikube
      - run:
          command: >
            kubectl create -f conformance/StageConformanceTestsData.yaml;
            kubectl wait --for=condition=complete --timeout 180s job/stage-conformance-test-data;
            kubectl logs job/stage-conformance-test-data
      # Create roles/bindings to grant API access
      - run:
          command: >
            kubectl create role pod-manager-role --verb=create,patch,delete,list,watch --resource=pods;
            kubectl create role log-reader-role --verb=get,list --resource=pods/log;
            kubectl create rolebinding pod-manager-default-binding--role=pod-manager-role --serviceaccount=default;
            kubectl create rolebinding log-reader-default-binding --role=log-reader-role --serviceaccount=default;
      - run:
          command: ./conformance/run-conformance.sh
      # Cleanup
      - run:
          command: kubectl delete -f conformance/StageConformanceTestsData.yaml
